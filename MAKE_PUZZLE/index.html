<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>fanmade Witness Stage Editor</title>
  <style>
    /* 全体レイアウト */
    body {
      margin: 0; display: flex; background: #222; color: #fff;
      font-family: sans-serif; height: 100vh; overflow: hidden;
    }

    /* キャンバスエリア */
    #canvas-container {
      flex: 1; position: relative;
      display: flex; justify-content: center; align-items: flex-start;
      background: #333; overflow: auto; padding: 20px;
    }
    
    canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); margin: auto; }

    /* サイドバー */
    #toolbar {
      width: 320px; background: #2a2a2a; border-left: 1px solid #444;
      padding: 20px; box-sizing: border-box; overflow-y: auto; flex-shrink: 0;
    }

    /* ゲームUI (HUD) */
    #game-hud {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85); padding: 10px 30px; border-radius: 50px;
      display: flex; gap: 40px; pointer-events: none; z-index: 10;
      border: 1px solid #555; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .hud-item { display: flex; flex-direction: column; align-items: center; }
    .hud-item span { color: #aaa; font-size: 11px; letter-spacing: 1px; margin-bottom: 2px; }
    .hud-val { font-family: monospace; font-size: 28px; font-weight: bold; color: white; }
    #timer-val { color: lime; }
    #timer-val.warning { color: #ff3333; animation: blink 0.5s infinite alternate; }
    @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

    /* オーバーレイ (修正: hiddenを強力に) */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 100;
      text-align: center; transition: opacity 0.3s;
    }
    
    /* ★修正: !important をつけて強制的に消す */
    #overlay.hidden {
      display: none !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    #overlay h1 { font-size: 48px; margin: 0 0 20px 0; color: white; letter-spacing: 2px; }
    #overlay p { font-size: 18px; color: #ccc; margin-bottom: 40px; }
    #overlay button {
      width: auto; padding: 15px 60px; font-size: 24px; background: #007bff;
      border: none; color: white; cursor: pointer; border-radius: 50px;
      font-weight: bold; box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
    }
    #overlay button:hover { background: #0056b3; transform: scale(1.05); }

    /* ツールバー部品 */
    h3 { margin-top: 0; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; padding-bottom: 5px; }
    .tool-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #444; }
    button, select, input[type="number"] {
      width: 100%; padding: 10px; margin-bottom: 8px; background: #444;
      color: white; border: 1px solid #555; border-radius: 4px;
      cursor: pointer; box-sizing: border-box; font-size: 14px;
    }
    button:hover { background: #555; }
    button:active { background: #666; }
    label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; color: #ddd; }
    input[type="number"] { width: 70px; text-align: right; background: #333; }
    #status {
      font-weight: bold; color: lime; text-align: center; margin-bottom: 20px;
      padding: 10px; background: #000; border-radius: 4px; font-size: 14px; border: 1px solid #333;
    }
    #poly-grid-container div { transition: background-color 0.1s; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

  <script src="main.js"></script>
  <script src="logic.js"></script>
  <script src="view.js"></script>
  <script src="editor.js"></script>
  <script src="solver.js"></script>
</head>
<body>

  <div id="canvas-container">
    <div id="game-hud" class="hidden" style="display:none;">
      <div class="hud-item"><span>TIME</span> <div id="timer-val" class="hud-val">00:00</div></div>
      <div class="hud-item"><span>PUZZLE</span> <div id="stage-val" class="hud-val">1 / 3</div></div>
    </div>
    <div id="overlay">
      <h1 id="overlay-title">PUZZLE CHALLENGE</h1>
      <p id="overlay-msg">Ready?</p>
      <button id="overlay-btn" onclick="startStageGame()">START GAME</button>
    </div>
  </div>

  <div id="toolbar">
    <div id="status">MODE: PLAY</div>
    
    <div class="tool-section">
      <h3>Game Mode</h3>
      <button onclick="showTitleScreen()" style="background: #e65100; border-color: #f57c00; font-weight:bold;">★ タイトル画面へ (Start Stage)</button>
    </div>

    <div class="tool-section">
      <h3>Editor Menu</h3>
      <button onclick="toggleMode()">Play / Edit 切替</button>
      <button onclick="solvePuzzle()">自動解法チェック (Solve)</button>
      <div style="display: flex; gap: 5px;">
        <button onclick="exportStageJSON()">ステージ保存 (Export)</button>
        <button onclick="importStageJSON()">ステージ読込 (Import)</button>
      </div>
    </div>

    <div class="tool-section" id="puzzle-manager" style="display:none;">
      <h3 style="color:#00e5ff;">Puzzle Manager</h3>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="navPuzzle(-1)" style="width:30%; font-weight:bold;">◀ Prev</button>
        <span id="puzzle-indicator" style="font-weight:bold; font-size:16px;">1 / 1</span>
        <button onclick="navPuzzle(1)" style="width:30%; font-weight:bold;">Next ▶</button>
      </div>
      <div style="display:flex; gap:5px;">
        <button onclick="addPuzzle()" style="background:#2e7d32;">＋ Add New</button>
        <button onclick="deletePuzzle()" style="background:#c62828;">－ Delete</button>
      </div>
    </div>

    <div class="tool-section" id="stage-settings" style="display:none;">
      <h3 style="color:#ffcc00;">Stage Settings</h3>
      <label>制限時間 (秒): <input type="number" id="stage-time-limit" value="60" min="10" max="999"></label>
    </div>

    <div class="tool-section" id="grid-settings" style="display:none;">
      <h3>Grid Settings</h3>
      <label>Cols (横): <input type="number" id="grid-cols" value="4" min="1" max="10"></label>
      <label>Rows (縦): <input type="number" id="grid-rows" value="4" min="1" max="10"></label>
      <button onclick="applyGridResize()" style="margin-top:5px; background:#556;">サイズ変更 (Resize)</button>
    </div>

    <div class="tool-section" id="editor-tools" style="display:none;">
      <h3>Tools</h3>
      <select id="tool-select" onchange="togglePolyEditor()">
        <option value="start">スタート地点 (Start)</option>
        <option value="goal">ゴール地点 (End)</option>
        <option value="wall">壁 (Wall)</option>
        <option value="square">色付き四角 (Square)</option>
        <option value="star">星 (Star)</option>
        <option value="tetris">テトリス (Polyomino)</option>
        <option value="triangle">三角形 (Triangle)</option>
        <option value="hexagon">通過必須 (Hexagon)</option>
        <option value="eliminator">消去マーク (Eliminator)</option>
        <option value="delete">削除ゴム (Eraser)</option>
      </select>
      
      <div id="poly-creator" style="display:none; margin-top:10px; margin-bottom:15px; border:1px solid #555; padding:10px; background:#222; border-radius: 4px;">
        <p style="margin:0 0 8px 0; font-size:12px; color:#aaa; text-align:center;">形をクリックで作る</p>
        <div id="poly-grid-container" style="display:grid; grid-template-columns: repeat(5, 20px); gap:2px; justify-content:center;"></div>
        <div style="font-size:10px; color:#666; margin-top:8px; text-align:center;">※黄色い部分が配置されます</div>
      </div>

      <h3>Properties</h3>
      <select id="color-select">
        <option value="0">白 (White)</option>
        <option value="1">黒 (Black)</option>
        <option value="2">水色 (Cyan)</option>
        <option value="3">ピンク (Pink)</option>
        <option value="4">黄色 (Yellow)</option>
        <option value="5">赤 (Red)</option>
        <option value="6">緑 (Green)</option>
        <option value="7">青 (Blue)</option>
        <option value="8">オレンジ (Orange)</option>
      </select>
      
      <label style="margin-top:10px;">三角形の数: <input type="number" id="param-input" value="1" min="1" max="4"></label>
    </div>
  </div>

  <script>
    window.onload = function() {
      setTimeout(() => {
        // ロード時にタイトル画面を表示
        if (typeof showTitleScreen === 'function') {
          showTitleScreen();
        }
      }, 100);
    };
  </script>
</body>
</html>